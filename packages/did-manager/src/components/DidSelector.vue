<template>
  <div class="flex flex-col items-center justify-center w-full h-full">
    <h3 class="text-xl font-semibold text-center text-white mb-4">Connect an Identity</h3>
    <p class="text-gray-500 text-sm font-semibold text-center mb-8">
      Your DID uniquely identifies you on<br />decentralized platforms.
    </p>

    <div class="border border-gray-700 rounded-lg p-4 w-full max-w-md">
      <label for="localselectedDid" class="text-white text-sm font-medium mb-2 block">Select DID Profile</label>
      <select
        v-model="localSelectedDid"
        class="w-full bg-transparent text-white bg-gray-800 text-base border border-gray-700 rounded px-3 py-2 mb-4 focus:ring-2 focus:ring-[#D7DF23] outline-none"
      >
        <option value="" disabled class="text-white bg-[#15161E]">Choose an ID</option>
        <option
          v-for="entry in storedDids"
          :key="entry.did"
          :value="entry.did"
          class="text-white bg-[#15161E]"
        >
          {{ entry.name ? `${entry.name} - ${truncateDid(entry.did)}` : truncateDid(entry.did) }}
        </option>
      </select>
    </div>

    <p v-if="storedDids.length === 0" class="text-gray-500 text-sm text-center mt-4">
      No IDs found.
    </p>
    <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
  </div>
</template>

<script>
import CryptoJS from 'crypto-js';

export default {
  name: 'DidSelector',
  props: {
    dids: {
      type: Array,
      default: () => [],
    },
    extensionPassword: {
      type: String,
      default: '',
    },
  },
  data() {
    return {
      localSelectedDid: '',
      errorMessage: '',
      storedDids: [],
    };
  },
  mounted() {
    this.loadStoredDids();
  },
  watch: {
    localSelectedDid(newVal) {
      this.errorMessage = '';
      if (newVal) {
        this.confirmSelection();
      }
    },
    dids: {
      handler() {
        this.loadStoredDids();
      },
      deep: true,
    },
    extensionPassword() {
      this.loadStoredDids();
    },
  },
  methods: {
    loadStoredDids() {
      chrome.storage.local.get(['didKeyPairs'], (result) => {
        if (chrome.runtime.lastError) {
          console.error('Error retrieving didKeyPairs:', chrome.runtime.lastError.message);
          this.errorMessage = 'Error loading DID profiles.';
          return;
        }

        let stored = {};
        if (result.didKeyPairs) {
          try {
            if (this.extensionPassword) {
              const decrypted = CryptoJS.AES.decrypt(
                result.didKeyPairs,
                this.extensionPassword,
                { mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
              ).toString(CryptoJS.enc.Utf8);
              stored = JSON.parse(decrypted || '{}');
            } else {
              // Handle first-time users with unencrypted didKeyPairs
              stored = JSON.parse(result.didKeyPairs || '{}');
            }
          } catch (error) {
            console.error('Error decrypting didKeyPairs:', error.message);
            this.errorMessage = 'Failed to decrypt DID profiles. Please ensure your password is correct.';
            return;
          }
        }

        this.storedDids = Object.keys(stored)
          .map((did) => ({
            did,
            name: stored[did].name || '',
            createdAt: stored[did].createdAt || new Date().toISOString(),
          }))
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        if (this.storedDids.length === 0) {
          this.errorMessage = 'No DID profiles found. Please generate or restore a DID.';
        }
      });
    },
    confirmSelection() {
      if (!this.localSelectedDid) {
        this.errorMessage = 'Please select a DID.';
        return;
      }

      this.errorMessage = '';
      console.log('Selected DID:', this.localSelectedDid);

      // Emit DID as an object for nonce signing
      this.$emit('did-selected', { did: this.localSelectedDid });

      // Post message to content script
      window.postMessage(
        {
          action: 'did-selected',
          did: { did: this.localSelectedDid },
        },
        window.location.origin
      );
    },
    truncateDid(did) {
      return did.length > 30 ? `${did.slice(0, 16)}...${did.slice(-16)}` : did;
    },
  },
};
</script>

<style scoped>
* {
  font-family: 'Rethink Sans', sans-serif !important;
}

::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-track {
  background: #1a1b24;
}
::-webkit-scrollbar-thumb {
  background: #4b4e6d;
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: #d7df23;
}

select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23D7DF23' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1em;
}
</style>